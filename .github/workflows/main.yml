name: NEW REPO - NEW KEY - TAILSCALE RDP

on:
  workflow_dispatch:

jobs:
  rdp_tailscale:
    runs-on: windows-latest
    timeout-minutes: 360 

    env:
      TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }} # ENSURE THIS IS THE NEW KEY!
      RDP_USER: coder_fresh
      RDP_PASS: ${{ secrets.ADMIN_PASS }} 
      RDP_PORT: 3389

    steps:
      
      # 1. Setup Admin Credentials
      - name: üõ†Ô∏è Setup Admin User
        run: |
          net user $env:RDP_USER $env:RDP_PASS /add /y
          net localgroup Administrators $env:RDP_USER /add
          net localgroup "Remote Desktop Users" $env:RDP_USER /add
        shell: powershell
        
      # 2. RDP Security Fixes (Reset to Strongest Compatibility)
      - name: ‚öôÔ∏è RDP Security Reset for Tailscale
        run: |
          Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
          Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "UserAuthentication" -Value 0 # NLA Disable
          Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "SecurityLayer" -Value 0 # RDP Protocol Security
          Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "MinEncryptionLevel" -Value 1 # Low Encryption for Compatibility
          Restart-Service -Name TermService -Force
        shell: powershell
        
      # 3. üõ†Ô∏è CORE TOOLS: Install Tailscale, WSL, Kali Linux
      - name: üíª Install Tools and Kali Linux
        run: |
          # Tailscale, VS Code, Node.js
          choco install tailscale visualstudiocode nodejs -y --no-progress
          
          # Kali Linux Installation
          dism.exe /online /enable-feature /featurename:VirtualMachinePlatform /all /norestart
          dism.exe /online /enable-feature /featurename:Microsoft-Windows-Subsystem-Linux /all /norestart
          Invoke-WebRequest -Uri https://aka.ms/wsl-kali-linux-new -OutFile C:\temp\Kali-Linux.appx
          Add-AppxPackage C:\temp\Kali-Linux.appx
          wsl --set-default-version 2
          
          Start-Sleep -Seconds 30 
        shell: powershell
        
      # 4. Connect to Tailscale Network (As Exit Node for best routing)
      - name: üîí Connect to Tailscale Network (NEW KEY)
        run: |
          Start-Sleep -Seconds 20 
          # Exit Node ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡•á‡§Ç (Tailscale routing ‡§ï‡•ã ‡§Æ‡§ú‡§¨‡•Ç‡§∞ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è)
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey="$env:TAILSCALE_AUTHKEY" --hostname="clean-rdp-node" --accept-routes --advertise-exit-node
          Start-Sleep -Seconds 10 
        shell: powershell
        
      # 5. Configure Firewall and Get IP (Strong Firewall Rule)
      - name: üõ°Ô∏è RDP Firewall Override and Get IP
        run: |
          # Tailscale IP ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡§†‡•ã‡§∞ ‡§´‡§º‡§æ‡§Ø‡§∞‡§µ‡•â‡§≤ ‡§®‡§ø‡§Ø‡§Æ
          New-NetFirewallRule -DisplayName 'RDP_TAILSCALE_OVERRIDE_TCP' -Direction Inbound -LocalPort $env:RDP_PORT -Protocol TCP -Action Allow -Profile Any -RemoteAddress Any
          
          $TS_IP = (& "C:\Program Files\Tailscale\tailscale.exe" ip -4)
          echo "TS_IP=$TS_IP" | Out-File -FilePath $env:GITHUB_ENV -Append
        shell: powershell
        
      # 6. Display Connection Details 
      - name: üñ•Ô∏è Display Connection Details 
        shell: bash
        run: |
          echo "********************************************************"
          echo "  ‚úÖ NEW REPO / NEW KEY RDP READY ‚úÖ"
          echo "********************************************************"
          echo "üî• Tailscale IP: ${TS_IP}"
          echo "üåê RDP Port:     ${RDP_PORT}"
          echo "üë§ Username:      ${RDP_USER}"
          echo "üîë Password:      (Secret: ADMIN_PASS)"
          echo "********************************************************"
          echo "üö® RDP ‡§∏‡•á ‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§ï‡§∞‡§®‡•á ‡§∏‡•á ‡§™‡§π‡§≤‡•á, ‡§Ö‡§™‡§®‡•á ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§™‡§∞ Exit Node ‡§ï‡•ã ‡§á‡§®‡•á‡§¨‡§≤ ‡§ï‡§∞‡•á‡§Ç‡•§"
        
      # 7. Keep Session Alive
      - name: ‚è≥ Keep Session Alive
        run: Start-Sleep 21600
        shell: powershell
