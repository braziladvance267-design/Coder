name: TAILSCALE RDP - FIXING 'INITIATING CONNECTION' (FINAL ATTEMPT)

on:
  workflow_dispatch:

jobs:
  rdp_tailscale:
    runs-on: windows-latest
    timeout-minutes: 360 

    env:
      TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }} # NEW KEY HERE
      RDP_USER: coder_fresh
      RDP_PASS: ${{ secrets.ADMIN_PASS }} # Strong password (e.g., GITHUB@CODER1)

    steps:
      
      # 1. Setup Admin Credentials (Must be strong)
      - name: üõ†Ô∏è Setup Admin User
        run: |
          net user $env:RDP_USER $env:RDP_PASS /add /y
          net localgroup Administrators $env:RDP_USER /add
          net localgroup "Remote Desktop Users" $env:RDP_USER /add
        shell: powershell
        
      # 2. üõ°Ô∏è RDP Security Fixes (Crucial for new VM image)
      - name: ‚öôÔ∏è Reset RDP Security Settings
        run: |
          # NLA (Network Level Authentication) ‡§ï‡•ã ‡§°‡§ø‡§∏‡•á‡§¨‡§≤ ‡§ï‡§∞‡•á‡§Ç - RDP fail ‡§π‡•ã‡§®‡•á ‡§ï‡§æ ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§ï‡§æ‡§∞‡§£
          Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "UserAuthentication" -Value 0 
          # RDP ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§∏‡•ç‡§µ‡•Ä‡§ï‡§æ‡§∞ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è VM ‡§ï‡•ã ‡§ï‡•â‡§®‡•ç‡§´‡§º‡§ø‡§ó‡§∞ ‡§ï‡§∞‡•á‡§Ç
          Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
          Restart-Service -Name TermService -Force
        shell: powershell

      # 3. üõ†Ô∏è Install Tailscale and Kali Linux
      - name: üíª Install Tools, Tailscale and Kali Linux
        run: |
          choco install tailscale -y --no-progress
          
          # Kali Linux Setup...
          dism.exe /online /enable-feature /featurename:VirtualMachinePlatform /all /norestart
          # ... (rest of Kali setup)
          
          Start-Sleep -Seconds 30 
        shell: powershell
        
      # 4. Connect to Tailscale Network 
      - name: üîí Connect to Tailscale Network 
        run: |
          Start-Service -Name Tailscale -Force
          Start-Sleep -Seconds 5
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey="$env:TAILSCALE_AUTHKEY" --hostname="rdp-fresh-fix"
          Start-Sleep -Seconds 10 
        shell: powershell
        
      # 5. Get IP and Display Details 
      - name: üñ•Ô∏è Display Connection Details 
        run: |
          $TS_IP = (& "C:\Program Files\Tailscale\tailscale.exe" ip -4)
          echo "TS_IP=$TS_IP" | Out-File -FilePath $env:GITHUB_ENV -Append
        shell: powershell
      - name: Final Log Output
        shell: bash
        run: |
          echo "********************************************************"
          echo "  ‚úÖ TAILSCALE RDP ACCESS READY ‚úÖ"
          echo "********************************************************"
          echo "üî• Tailscale IP: ${TS_IP}"
          echo "üåê RDP Port:     3389"
          echo "üë§ User: ${RDP_USER}"
          echo "üîë Pass: (Secret: ADMIN_PASS)"
          echo "********************************************************"
          echo "üö® Important: Mobile ‡§™‡§∞ Tailscale App ‡§ö‡§æ‡§≤‡•Ç ‡§π‡•ã‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è!"
        
      # 6. Keep Session Alive
      - name: ‚è≥ Keep Session Alive
        run: Start-Sleep 21600
        shell: powershell

