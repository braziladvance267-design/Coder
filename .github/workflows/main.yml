name: ULTIMATE RDP ACCESS WITH TAILSCALE & KALI (V2.0 FIX)

on:
  workflow_dispatch:

jobs:
  rdp_tailscale_kali:
    runs-on: windows-latest
    timeout-minutes: 360 

    env:
      TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }} 
      RDP_USER: coder_wsl
      RDP_PASS: ${{ secrets.ADMIN_PASS }} 
      TS_HOSTNAME: fixed-runner-${{ github.run_id }}

    steps:
      
      # 1. Setup Admin Credentials
      - name: üõ†Ô∏è Setup Admin User
        run: |
          net user $env:RDP_USER $env:RDP_PASS /add /y
          net localgroup Administrators $env:RDP_USER /add
          net localgroup "Remote Desktop Users" $env:RDP_USER /add
        shell: powershell
        
      # 2. üõ°Ô∏è RDP Security Fixes 
      - name: ‚öôÔ∏è Reset RDP Security Settings
        run: |
          Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "UserAuthentication" -Value 0 
          Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
          Restart-Service -Name TermService -Force
        shell: powershell

      # 3. üíª Install VS Code and Tailscale (Added VS Code)
      - name: üíª Install VS Code, Tailscale and Dependencies
        run: |
          # VS Code for Remote Access (Optional but useful)
          choco install vscode -y --no-progress
          
          # Install Tailscale
          choco install tailscale -y --no-progress
          
          # Enable WSL features
          dism.exe /online /enable-feature /featurename:VirtualMachinePlatform /all /norestart
          dism.exe /online /enable-feature /featurename:Microsoft-Windows-Subsystem-Linux /all /norestart
          Start-Sleep -Seconds 30 
        shell: powershell
        
      # 4. Install Kali Linux (WSL)
      - name: üêß Install Kali Linux Distribution
        run: |
          Invoke-WebRequest -Uri https://aka.ms/wsl-kali-linux-new -OutFile C:\temp\Kali-Linux.appx
          Add-AppxPackage C:\temp\Kali-Linux.appx
          wsl --set-default-version 2
          Start-Sleep -Seconds 45 
        shell: powershell
        
      # 5. Connect to Tailscale Network (FIXED ERROR HERE)
      - name: üîí Connect to Tailscale Network 
        run: |
          # ERROR FIX: Removed -Force from Start-Service
          Start-Service -Name Tailscale 
          Start-Sleep -Seconds 5
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey="$env:TAILSCALE_AUTHKEY" --hostname="$env:TS_HOSTNAME"
          Start-Sleep -Seconds 10 
        shell: powershell
        
      # 6. Get IP and Display Details 
      - name: üñ•Ô∏è Display Connection Details 
        run: |
          $TS_IP = (& "C:\Program Files\Tailscale\tailscale.exe" ip -4)
          echo "TS_IP=$TS_IP" | Out-File -FilePath $env:GITHUB_ENV -Append
        shell: powershell
      - name: Final Log Output
        shell: bash
        run: |
          echo "********************************************************"
          echo "  ‚úÖ RDP + KALI LINUX ACCESS READY (FINAL FIX) ‚úÖ"
          echo "********************************************************"
          echo "üî• Tailscale IP: ${TS_IP}"
          echo "üåê RDP Port:     3389"
          echo "üë§ RDP User:     ${RDP_USER}"
          echo "üîë RDP Pass:     (Secret: ADMIN_PASS)"
          echo "********************************************************"
          echo "üí° Kali: Open RDP/CMD and type 'wsl'. VS Code is also installed."
        
      # 7. Keep Session Alive
      - name: ‚è≥ Keep Session Alive
        run: Start-Sleep 21600
        shell: powershell

